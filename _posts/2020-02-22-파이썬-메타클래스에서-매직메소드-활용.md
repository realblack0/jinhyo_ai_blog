# metaclass with magic method

Keyword: __new__, __init__, __call__
Part: Python
Status: 완료

# python에서 객체를 생성할 때는 __new__와 __init__ 가 사용된다. (2가지)

- __new__ 는 생성자이다.  클래스의 인스턴스를 만들기만 한다.
- __init__ 는 클래스의 속성을 초기화한다.(initialize)

### __new__ 를 실행할 때 주의점

- 클래스 자기 자신을 인자로 받는다. 주로 `cls`  이라고 씀.
    - `def __new__(cls, *args, **kwargs)`
    - 보통 instance(주로  `self` 라고 쓰는 그것)를 인자로 받는 것과 차이가 있다.
- return이 반드시 인스턴스가 아니어도 된다.
    - 단, 인스턴스를 반환하지 않을 경우는 인스턴스화가 되지 않음에 유의.

### __init__ 를 실행하는 2가지 방법

- 클래스에서 실행하는 방법
    - `cls.__init__(instance, *args, **kwargs)`
    - 클래스에서 실행할 때에는 instance를 지정해줘야한다. (보통 self로 쓰는 그것)
- 인스턴스에서 실행하는 방법
    - `instance.__init__(*args, **kwargs)`  (instance는 인스턴스 객체)
    - 인스턴스에서 실행할 때에는 self에 인스턴스 자기자신이 자동으로 들어간다.

### __call__의 역할

- __new__ 가 인스턴스 객체를 반환하지 않을 경우, __call__은 __init__를 실행하지 않는다.
- __call__ 을 오버라이딩할 경우, __new__와 __init__를 따로 실행해줘야 한다.
    - __new__는 __init__를 자동으로 실행하지 않음
    - `__new__(cls, [...])` , `__init__(instance, [...])`  ⇒ __new__와 __init__는 첫번째 인자만 다르고 나머지는 동일하게 입력한다.

---

## 메타 클래스에서 생성자 자유로이 사용하기

※ 클래스에서 생성자를 사용하는 것과 헷갈릴 수 있으므로 주의하기.

- 위 설명에서 cls는 meta, self는 cls로 바꿔서 이해하면 됨 (메타클래스는 클래스의 클래스이므로)

    class MetaType(type): # type을 상속 받아서 metaclass를 생성
        def __new__(meta, metaname, bases, attrs): # cls가 아니라 meta를 받음
            print('MetaType is used')
            return super(MetaType, meta).__new__(meta, metaname, bases, attrs)
    #         return type.__new__(meta, metaname, bases, attrs)   # 이렇게도 가능
    
        def __init__(cls, *args, **kwargs):
            print("MyClass is initialized")
            cls.a = 'class attribute from meta'  # 메타클래스에서 클래스의 속성을 정의 가능
        
        def __call__(cls, *args, **kwargs):
            print('MyClass is called')
            instance = cls.__new__(cls, *args, **kwargs)    # 인스턴스만 생성
    #         instance.__init__(*args, **kwargs)   # 이렇게도 가능
            cls.__init__(instance, *args, **kwargs)         # 인스턴스 속성 초기화
            return instance # class에 call 했을때 인스턴스 객체를 반환

    class MyClass(metaclass=MetaType):
        b = 'class attribute'
    
        def __init__(self, d):
            self.c = 'instance attribute'
            self.d = d

*MetaType is used*

*MyClass is initialized*

    print(MyClass.a)
    print(MyClass.b)

*class attribute from meta*

*class attribute*

    myInstance = MyClass(1)

*MyClass is called*

    vars(myInstance)

{'c': 'instance attribute', 'd': 1}